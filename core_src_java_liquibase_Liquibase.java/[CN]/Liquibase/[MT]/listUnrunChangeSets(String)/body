{
  LockManager lockManager=LockManager.getInstance(database);
  lockManager.waitForLock();
  try {
    database.checkDatabaseChangeLogTable();
    DatabaseChangeLog changeLog=ChangeLogParserFactory.getInstance().getParser(changeLogFile).parse(changeLogFile,changeLogParameters,fileOpener);
    changeLog.validate(database);
    ChangeLogIterator logIterator=new ChangeLogIterator(changeLog,new ShouldRunChangeSetFilter(database),new ContextChangeSetFilter(contexts),new DbmsChangeSetFilter(database));
    ListVisitor visitor=new ListVisitor();
    logIterator.run(visitor,database);
    return visitor.getSeenChangeSets();
  }
  finally {
    lockManager.releaseLock();
  }
}
