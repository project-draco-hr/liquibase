{
  LockHandler lockHandler=LockHandler.getInstance(database);
  lockHandler.waitForLock();
  try {
    database.checkDatabaseChangeLogTable();
    DatabaseChangeLog changeLog=new ChangeLogParser(changeLogParameters).parse(changeLogFile,fileOpener);
    changeLog.validate(database);
    ChangeLogIterator logIterator=new ChangeLogIterator(changeLog,new ShouldRunChangeSetFilter(database),new ContextChangeSetFilter(contexts),new DbmsChangeSetFilter(database));
    logIterator.run(new UpdateVisitor(database),database);
  }
 catch (  LiquibaseException e) {
    throw e;
  }
 finally {
    try {
      lockHandler.releaseLock();
    }
 catch (    LockException e) {
      log.log(Level.SEVERE,"Could not release lock",e);
    }
  }
}
