{
  try {
    if (!hasChangeLogLock) {
      checkDatabaseChangeLogTable();
    }
    boolean locked=false;
    long timeToGiveUp=new Date().getTime() + changeLogLockWaitTime;
    while (!locked && new Date().getTime() < timeToGiveUp) {
      locked=aquireLock();
      if (!locked) {
        log.info("Waiting for changelog lock....");
        try {
          Thread.sleep(1000 * 10);
        }
 catch (        InterruptedException e) {
          ;
        }
      }
    }
    if (!locked) {
      DatabaseChangeLogLock[] locks=listLocks();
      String lockedBy;
      if (locks.length > 0) {
        DatabaseChangeLogLock lock=locks[0];
        lockedBy=lock.getLockedBy() + " since " + DateFormat.getDateTimeInstance(DateFormat.SHORT,DateFormat.SHORT).format(lock.getLockGranted());
      }
 else {
        lockedBy="UNKNOWN";
      }
      log.severe("Could not aquire change log lock.  Currently locked by " + lockedBy);
      return;
    }
    Writer outputSQLWriter=getOutputSQLWriter();
    if (outputSQLWriter == null) {
      log.info("Reading changelog " + changeLogFile);
    }
 else {
      if (!outputtedHeader) {
        outputSQLWriter.write("--------------------------------------------------------------------------------------" + StreamUtil.getLineSeparator());
        if (mode.equals(OUTPUT_SQL_MODE)) {
          outputSQLWriter.write("-- SQL to update database to newest version" + StreamUtil.getLineSeparator());
        }
 else         if (mode.equals(OUTPUT_CHANGELOG_ONLY_SQL_MODE)) {
          outputSQLWriter.write("-- SQL to add all changesets to database history table" + StreamUtil.getLineSeparator());
        }
 else         if (mode.equals(OUTPUT_ROLLBACK_SQL_MODE)) {
          String stateDescription;
          if (getRollbackToTag() != null) {
            stateDescription=getRollbackToTag();
          }
 else           if (getRollbackToDate() != null) {
            stateDescription=DateFormat.getDateTimeInstance(DateFormat.SHORT,DateFormat.SHORT).format(getRollbackToDate());
          }
 else           if (getRollbackCount() != null) {
            stateDescription=getRollbackCount() + " change set ago";
          }
 else {
            throw new RuntimeException("Unknown rollback type");
          }
          outputSQLWriter.write("-- SQL to roll-back database to the state it was at " + stateDescription + StreamUtil.getLineSeparator());
        }
 else         if (mode.equals(OUTPUT_FUTURE_ROLLBACK_SQL_MODE)) {
          outputSQLWriter.write("-- SQL to roll-back database from an updated buildVersion back to current version" + StreamUtil.getLineSeparator());
        }
 else {
          throw new MigrationFailedException("Unexpected output mode: " + mode);
        }
        outputSQLWriter.write("-- Change Log: " + changeLogFile + StreamUtil.getLineSeparator());
        outputSQLWriter.write("-- Ran at: " + DateFormat.getDateTimeInstance(DateFormat.SHORT,DateFormat.SHORT).format(new Date()) + StreamUtil.getLineSeparator());
        outputSQLWriter.write("-- Against: " + getDatabase().getConnectionUsername() + "@"+ getDatabase().getConnectionURL()+ StreamUtil.getLineSeparator());
        outputSQLWriter.write("--------------------------------------------------------------------------------------" + StreamUtil.getLineSeparator() + StreamUtil.getLineSeparator()+ StreamUtil.getLineSeparator());
        outputtedHeader=true;
      }
    }
    if (mode.equals(EXECUTE_MODE) || mode.equals(OUTPUT_SQL_MODE) || mode.equals(OUTPUT_CHANGELOG_ONLY_SQL_MODE)) {
      runChangeLogs(new UpdateDatabaseChangeLogHandler(this,changeLogFile));
    }
 else     if (mode.equals(EXECUTE_ROLLBACK_MODE) || mode.equals(OUTPUT_ROLLBACK_SQL_MODE)) {
      RollbackDatabaseChangeLogHandler rollbackHandler;
      if (getRollbackToDate() != null) {
        rollbackHandler=new RollbackDatabaseChangeLogHandler(this,changeLogFile,getRollbackToDate());
      }
 else       if (getRollbackToTag() != null) {
        if (!getDatabase().doesTagExist(getRollbackToTag())) {
          throw new MigrationFailedException("'" + getRollbackToTag() + "' is not tag that exists in the database");
        }
        rollbackHandler=new RollbackDatabaseChangeLogHandler(this,changeLogFile,getRollbackToTag());
      }
 else       if (getRollbackCount() != null) {
        rollbackHandler=new RollbackDatabaseChangeLogHandler(this,changeLogFile,getRollbackCount());
      }
 else {
        throw new RuntimeException("Don't know what to rollback to");
      }
      runChangeLogs(rollbackHandler);
      ChangeSet unrollbackableChangeSet=rollbackHandler.getUnRollBackableChangeSet();
      if (unrollbackableChangeSet == null) {
        rollbackHandler.doRollback();
      }
 else {
        throw new MigrationFailedException("Cannot roll back changelog to selected date due to change set " + unrollbackableChangeSet);
      }
    }
 else     if (mode.equals(OUTPUT_FUTURE_ROLLBACK_SQL_MODE)) {
      RollbackFutureDatabaseChangeLogHandler rollbackHandler=new RollbackFutureDatabaseChangeLogHandler(this,changeLogFile);
      runChangeLogs(rollbackHandler);
      ChangeSet unrollbackableChangeSet=rollbackHandler.getUnRollBackableChangeSet();
      if (unrollbackableChangeSet == null) {
        rollbackHandler.doRollback();
      }
 else {
        throw new MigrationFailedException("Will not be able to rollback changes due to change set " + unrollbackableChangeSet);
      }
    }
 else {
      throw new MigrationFailedException("Unknown mode: " + getMode());
    }
    if (outputSQLWriter != null) {
      outputSQLWriter.flush();
    }
  }
 catch (  MigrationFailedException e) {
    throw e;
  }
catch (  Exception e) {
    throw new MigrationFailedException(e);
  }
 finally {
    releaseLock();
  }
}
