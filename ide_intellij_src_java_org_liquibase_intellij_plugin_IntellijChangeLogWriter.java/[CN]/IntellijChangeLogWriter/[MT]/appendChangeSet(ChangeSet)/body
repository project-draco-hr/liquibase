{
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      try {
        DocumentBuilder documentBuilder=createDocumentBuilder();
        VirtualFile file=LiquibaseProjectComponent.getInstance().getChangeLogVirtualFile();
        if (file == null) {
          throw new RuntimeException("Could not find file");
        }
        Document doc;
        if (!file.isValid() || file.getLength() == 0) {
          createEmptyChangeLog(file.getOutputStream(null));
        }
        doc=documentBuilder.parse(file.getInputStream());
        XMLChangeLogSerializer xmlChangeLogSerializer=new XMLChangeLogSerializer();
        xmlChangeLogSerializer.setCurrentChangeLogFileDOM(doc);
        doc.getDocumentElement().appendChild(xmlChangeLogSerializer.createNode(changeSet));
        OutputStream outputStream=file.getOutputStream(null);
        serializeXML(doc,outputStream);
        outputStream.flush();
        outputStream.close();
        file.refresh(false,false);
      }
 catch (      Exception e) {
        throw new RuntimeException(e);
      }
    }
  }
);
}
