{
  String dateValue=database.getCurrentDateTimeFunction();
  ChangeSet changeSet=statement.getChangeSet();
  SqlStatement runStatement;
  try {
    if (statement.getExecType().equals(ChangeSet.ExecType.FAILED) || statement.getExecType().equals(ChangeSet.ExecType.SKIPPED)) {
      return new Sql[0];
    }
    String tag=null;
    for (    Change change : changeSet.getChanges()) {
      if (change instanceof TagDatabaseChange) {
        TagDatabaseChange tagChange=(TagDatabaseChange)change;
        tag=tagChange.getTag();
      }
    }
    if (statement.getExecType().ranBefore) {
      runStatement=new UpdateStatement(database.getLiquibaseCatalogName(),database.getLiquibaseSchemaName(),database.getDatabaseChangeLogTableName()).addNewColumnValue("DATEEXECUTED",new DatabaseFunction(dateValue)).addNewColumnValue("MD5SUM",changeSet.generateCheckSum().toString()).addNewColumnValue("EXECTYPE",statement.getExecType().value).setWhereClause(database.escapeObjectName("ID",Column.class) + " = ? " + "AND "+ database.escapeObjectName("AUTHOR",Column.class)+ " = ? "+ "AND "+ database.escapeObjectName("FILENAME",Column.class)+ " = ?").addWhereParameters(changeSet.getId(),changeSet.getAuthor(),changeSet.getFilePath());
      if (tag != null) {
        ((UpdateStatement)runStatement).addNewColumnValue("TAG",tag);
      }
    }
 else {
      runStatement=new InsertStatement(database.getLiquibaseCatalogName(),database.getLiquibaseSchemaName(),database.getDatabaseChangeLogTableName()).addColumnValue("ID",changeSet.getId()).addColumnValue("AUTHOR",changeSet.getAuthor()).addColumnValue("FILENAME",changeSet.getFilePath()).addColumnValue("DATEEXECUTED",new DatabaseFunction(dateValue)).addColumnValue("ORDEREXECUTED",ChangeLogHistoryServiceFactory.getInstance().getChangeLogService(database).getNextSequenceValue()).addColumnValue("MD5SUM",changeSet.generateCheckSum().toString()).addColumnValue("DESCRIPTION",limitSize(changeSet.getDescription())).addColumnValue("COMMENTS",limitSize(StringUtils.trimToEmpty(changeSet.getComments()))).addColumnValue("EXECTYPE",statement.getExecType().value).addColumnValue("CONTEXTS",changeSet.getContexts() == null || changeSet.getContexts().isEmpty() ? null : changeSet.getContexts().toString()).addColumnValue("LABELS",changeSet.getLabels() == null || changeSet.getLabels().isEmpty() ? null : changeSet.getLabels().toString()).addColumnValue("LIQUIBASE",LiquibaseUtil.getBuildVersion().replaceAll("SNAPSHOT","SNP"));
      if (tag != null) {
        ((InsertStatement)runStatement).addColumnValue("TAG",tag);
      }
    }
  }
 catch (  LiquibaseException e) {
    throw new UnexpectedLiquibaseException(e);
  }
  return SqlGeneratorFactory.getInstance().generateSql(runStatement,database);
}
