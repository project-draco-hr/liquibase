{
  Connection conn=getConnection();
  PreparedStatement stmt=null;
  Statement countStatement=null;
  ResultSet countRS=null;
  try {
    stmt=conn.prepareStatement(createChangeToTagSQL());
    ResultSet rs=stmt.executeQuery();
    if (!rs.next()) {
      throw new MigrationFailedException("Did not tag database correctly");
    }
    Timestamp lastExecutedDate=rs.getTimestamp(1);
    rs.close();
    stmt.close();
    stmt=conn.prepareStatement(createTagSQL());
    stmt.setString(1,tagString);
    stmt.setTimestamp(2,lastExecutedDate);
    int rowsUpdated=stmt.executeUpdate();
    if (rowsUpdated == 0) {
      countStatement=conn.createStatement();
      countRS=countStatement.executeQuery("select count(*) from " + getDatabaseChangeLogTableName());
      countRS.next();
      if (countRS.getInt(1) == 0) {
        throw new MigrationFailedException("Cannot tag an empty database");
      }
      countRS.close();
      throw new MigrationFailedException("Did not tag database change log correctly");
    }
    conn.commit();
  }
 catch (  Exception e) {
    throw new MigrationFailedException(e);
  }
 finally {
    if (stmt != null) {
      try {
        stmt.close();
      }
 catch (      SQLException e) {
        ;
      }
    }
    if (countStatement != null) {
      try {
        countStatement.close();
      }
 catch (      SQLException e) {
        ;
      }
    }
  }
}
