{
  if (map.containsKey(key)) {
    Object mapValue=map.get(key);
    if (mapValue == null) {
      return null;
    }
    if (mapValue != null && mapValue instanceof String && ((String)mapValue).startsWith("${")) {
      mapValue=changeLogParameters.expandExpressions((String)mapValue);
    }
    if (type.isAssignableFrom(mapValue.getClass())) {
      return (T)mapValue;
    }
 else {
      if (type.equals(String.class)) {
        return (T)mapValue.toString();
      }
 else       if (type.equals(boolean.class) && mapValue.getClass().equals(Boolean.class)) {
        return (T)mapValue;
      }
 else {
        throw new UnexpectedLiquibaseException("Could not convert " + mapValue.getClass().getName() + " '"+ mapValue+ "' to "+ type.getName());
      }
    }
  }
 else {
    return defaultValue;
  }
}
