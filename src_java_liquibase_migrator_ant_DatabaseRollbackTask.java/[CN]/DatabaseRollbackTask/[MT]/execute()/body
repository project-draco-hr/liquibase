{
  if (getRollbackDate() == null && getRollbackCount() == null && getRollbackTag() == null) {
    throw new BuildException("rollbackDatabase requires rollbackTag, rollbackDate, or rollbackCount to be set");
  }
  Migrator migrator=null;
  try {
    migrator=createMigrator();
    migrator.setMode(Migrator.Mode.EXECUTE_ROLLBACK_MODE);
    migrator.setRollbackToDate(getRollbackDate());
    migrator.setRollbackToTag(getRollbackTag());
    migrator.setRollbackCount(getRollbackCount());
    migrator.migrate();
  }
 catch (  Exception e) {
    throw new BuildException(e);
  }
 finally {
    if (migrator != null && migrator.getDatabase() != null && migrator.getDatabase().getConnection() != null) {
      try {
        migrator.getDatabase().getConnection().close();
      }
 catch (      SQLException e) {
        throw new BuildException(e);
      }
    }
  }
}
