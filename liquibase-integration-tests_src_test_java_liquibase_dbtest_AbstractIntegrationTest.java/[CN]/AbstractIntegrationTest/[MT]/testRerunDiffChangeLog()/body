{
  if (database == null) {
    return;
  }
  for (int run=0; run < 2; run++) {
    boolean outputCsv=run == 1;
    runCompleteChangeLog();
    DatabaseSnapshot originalSnapshot=DatabaseSnapshotGeneratorFactory.getInstance().createSnapshot(database,new DiffControl());
    DiffControl diffControl=new DiffControl();
    diffControl.setDiffData(true);
    File tempFile=File.createTempFile("liquibase-test",".xml");
    if (outputCsv) {
      diffControl.setDataDir(new File(tempFile.getParentFile(),"liquibase-data").getCanonicalPath().replaceFirst("\\w:",""));
    }
    DiffResult diffResult=DiffGeneratorFactory.getInstance().compare(database,null,diffControl);
    FileOutputStream output=new FileOutputStream(tempFile);
    try {
      new DiffToChangeLog(diffResult).print(new PrintStream(output));
      output.flush();
    }
  finally {
      output.close();
    }
    Liquibase liquibase=createLiquibase(tempFile.getName());
    clearDatabase(liquibase);
    DatabaseSnapshot emptySnapshot=DatabaseSnapshotGeneratorFactory.getInstance().createSnapshot(database,new DiffControl());
    liquibase=createLiquibase(tempFile.getName());
    try {
      liquibase.update(this.contexts);
    }
 catch (    ValidationFailedException e) {
      e.printDescriptiveError(System.out);
      throw e;
    }
    DatabaseSnapshot migratedSnapshot=DatabaseSnapshotGeneratorFactory.getInstance().createSnapshot(database,new DiffControl());
    DiffResult finalDiffResult=DiffGeneratorFactory.getInstance().compare(originalSnapshot,migratedSnapshot,new DiffControl());
    try {
      assertTrue(finalDiffResult.areEqual());
    }
 catch (    AssertionError e) {
      new DiffToPrintStream(finalDiffResult,System.out).print();
      throw e;
    }
    DiffResult emptyDiffResult=DiffGeneratorFactory.getInstance().compare(emptySnapshot,migratedSnapshot,new DiffControl());
    output=new FileOutputStream(tempFile);
    try {
      new DiffToChangeLog(emptyDiffResult).print(new PrintStream(output));
      output.flush();
    }
  finally {
      output.close();
    }
    liquibase=createLiquibase(tempFile.getName());
    System.out.println("updating from " + tempFile.getCanonicalPath());
    try {
      liquibase.update(this.contexts);
    }
 catch (    LiquibaseException e) {
      throw e;
    }
    DatabaseSnapshot emptyAgainSnapshot=DatabaseSnapshotGeneratorFactory.getInstance().createSnapshot(database,new DiffControl());
    assertEquals(0,emptyAgainSnapshot.getDatabaseObjects(migratedSnapshot.getSchemas().iterator().next(),Table.class).size());
    assertEquals(0,emptyAgainSnapshot.getDatabaseObjects(migratedSnapshot.getSchemas().iterator().next(),View.class).size());
  }
}
