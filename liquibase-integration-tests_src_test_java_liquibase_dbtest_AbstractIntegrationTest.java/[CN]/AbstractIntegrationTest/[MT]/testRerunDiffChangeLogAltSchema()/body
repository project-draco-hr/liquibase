{
  if (database == null) {
    return;
  }
  if (!database.supportsSchemas()) {
    return;
  }
  Liquibase liquibase=createLiquibase(includedChangeLog);
  clearDatabase(liquibase);
  database.setDefaultSchemaName("liquibaseb");
  LockService.getInstance(database).forceReleaseLock();
  liquibase.update(includedChangeLog);
  DatabaseSnapshot originalSnapshot=DatabaseSnapshotGeneratorFactory.getInstance().createSnapshot(database,new DiffControl());
  DiffResult diffResult=DiffGeneratorFactory.getInstance().compare(database,null,new DiffControl(new Schema(Catalog.DEFAULT,"liquibaseb")));
  File tempFile=File.createTempFile("liquibase-test",".xml");
  FileOutputStream output=new FileOutputStream(tempFile);
  try {
    new DiffToChangeLog(diffResult).print(new PrintStream(output));
    output.flush();
  }
  finally {
    output.close();
  }
  liquibase=createLiquibase(tempFile.getName());
  clearDatabase(liquibase);
  Executor executor=ExecutorService.getInstance().getExecutor(database);
  try {
    executor.execute(new DropTableStatement("liquibaseb","liquibaseb",database.getDatabaseChangeLogTableName(),false));
  }
 catch (  DatabaseException e) {
  }
  try {
    executor.execute(new DropTableStatement("liquibaseb","liquibaseb",database.getDatabaseChangeLogLockTableName(),false));
  }
 catch (  DatabaseException e) {
  }
  database.commit();
  DatabaseConnection connection=DatabaseTestContext.getInstance().getConnection(url);
  database=DatabaseFactory.getInstance().findCorrectDatabaseImplementation(connection);
  database.setDefaultSchemaName("liquibaseb");
  liquibase=createLiquibase(tempFile.getName());
  try {
    liquibase.update(this.contexts);
  }
 catch (  ValidationFailedException e) {
    e.printDescriptiveError(System.out);
    throw e;
  }
  tempFile.deleteOnExit();
  DatabaseSnapshot finalSnapshot=DatabaseSnapshotGeneratorFactory.getInstance().createSnapshot(database,new DiffControl());
  DiffResult finalDiffResult=DiffGeneratorFactory.getInstance().compare(originalSnapshot,finalSnapshot,new DiffControl());
  new DiffToPrintStream(finalDiffResult,System.out).print();
  assertTrue(finalDiffResult.areEqual());
}
