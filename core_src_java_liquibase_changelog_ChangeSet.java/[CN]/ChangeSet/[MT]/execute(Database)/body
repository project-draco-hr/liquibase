{
  boolean skipChange=false;
  boolean markRan=true;
  Executor executor=ExecutorService.getInstance().getExecutor(database);
  try {
    database.setAutoCommit(!runInTransaction);
    executor.comment("Changeset " + toString());
    if (StringUtils.trimToNull(getComments()) != null) {
      String comments=getComments();
      String[] lines=comments.split("\n");
      for (int i=0; i < lines.length; i++) {
        if (i > 0) {
          lines[i]=database.getLineComment() + " " + lines[i];
        }
      }
      executor.comment(StringUtils.join(Arrays.asList(lines),"\n"));
    }
    if (preconditions != null) {
      try {
        preconditions.check(database,null);
      }
 catch (      PreconditionFailedException e) {
        StringBuffer message=new StringBuffer();
        message.append(StreamUtil.getLineSeparator());
        for (        FailedPrecondition invalid : e.getFailedPreconditions()) {
          message.append("          ").append(invalid.toString());
          message.append(StreamUtil.getLineSeparator());
        }
        if (preconditions.getOnFail().equals(PreconditionContainer.FailOption.HALT)) {
          e.printStackTrace();
          throw new MigrationFailedException(this,message.toString());
        }
 else         if (preconditions.getOnFail().equals(PreconditionContainer.FailOption.CONTINUE)) {
          skipChange=true;
          markRan=false;
          log.info("Continuing past ChangeSet: " + toString() + " due to precondition failure: "+ message);
        }
 else         if (preconditions.getOnFail().equals(PreconditionContainer.FailOption.MARK_RAN)) {
          skipChange=true;
          log.info("Marking ChangeSet: " + toString() + " ran due to precondition failure: "+ message);
        }
 else         if (preconditions.getOnFail().equals(PreconditionContainer.FailOption.WARN)) {
          log.warning("Running change set despite failed precondition.  ChangeSet: " + toString() + ": "+ message);
        }
 else {
          throw new MigrationFailedException(this,"Unexpected precondition onFail attribute: " + preconditions.getOnFail());
        }
      }
catch (      PreconditionErrorException e) {
        StringBuffer message=new StringBuffer();
        message.append(StreamUtil.getLineSeparator());
        for (        ErrorPrecondition invalid : e.getErrorPreconditions()) {
          message.append("          ").append(invalid.toString());
          message.append(StreamUtil.getLineSeparator());
        }
        if (preconditions.getOnError().equals(PreconditionContainer.ErrorOption.HALT)) {
          throw new MigrationFailedException(this,message.toString(),e);
        }
 else         if (preconditions.getOnError().equals(PreconditionContainer.ErrorOption.CONTINUE)) {
          skipChange=true;
          markRan=false;
          log.info("Continuing past ChangeSet: " + toString() + " due to precondition error: "+ message);
        }
 else         if (preconditions.getOnError().equals(PreconditionContainer.ErrorOption.MARK_RAN)) {
          skipChange=true;
          markRan=true;
          log.info("Marking ChangeSet: " + toString() + " due ran to precondition error: "+ message);
        }
 else         if (preconditions.getOnError().equals(PreconditionContainer.ErrorOption.WARN)) {
          log.warning("Running change set despite errored precondition.  ChangeSet: " + toString() + ": "+ message);
        }
 else {
          throw new MigrationFailedException(this,"Unexpected precondition onError attribute: " + preconditions.getOnError());
        }
        database.rollback();
      }
    }
    if (!skipChange) {
      for (      Change change : changes) {
        try {
          change.init();
        }
 catch (        SetupException se) {
          throw new MigrationFailedException(this,se);
        }
      }
      log.debug("Reading ChangeSet: " + toString());
      for (      Change change : getChanges()) {
        database.executeStatements(change,sqlVisitors);
        log.debug(change.getConfirmationMessage());
      }
      if (runInTransaction) {
        database.commit();
      }
      log.debug("ChangeSet " + toString() + " has been successfully run.");
    }
 else {
      log.debug("Skipping ChangeSet: " + toString());
    }
  }
 catch (  Exception e) {
    try {
      database.rollback();
    }
 catch (    Exception e1) {
      throw new MigrationFailedException(this,e);
    }
    if (getFailOnError() != null && !getFailOnError()) {
      log.info("Change set " + toString(false) + " failed, but failOnError was false",e);
    }
 else {
      if (e instanceof MigrationFailedException) {
        throw ((MigrationFailedException)e);
      }
 else {
        throw new MigrationFailedException(this,e);
      }
    }
  }
 finally {
    if (!runInTransaction && !database.getAutoCommitMode()) {
      try {
        database.setAutoCommit(false);
      }
 catch (      DatabaseException e) {
        throw new MigrationFailedException(this,"Could not reset autocommit");
      }
    }
  }
  return markRan;
}
