{
  boolean skipChange=false;
  boolean markRan=true;
  try {
    database.setAutoCommit(!runInTransaction);
    database.getJdbcTemplate().comment("Changeset " + toString());
    if (StringUtils.trimToNull(getComments()) != null) {
      String comments=getComments();
      String[] lines=comments.split("\n");
      for (int i=0; i < lines.length; i++) {
        if (i > 0) {
          lines[i]=database.getLineComment() + " " + lines[i];
        }
      }
      database.getJdbcTemplate().comment(StringUtils.join(Arrays.asList(lines),"\n"));
    }
    if (database.getJdbcTemplate().executesStatements() && rootPrecondition != null) {
      try {
        rootPrecondition.check(database,null);
      }
 catch (      PreconditionFailedException e) {
        StringBuffer message=new StringBuffer();
        message.append(StreamUtil.getLineSeparator());
        for (        FailedPrecondition invalid : e.getFailedPreconditions()) {
          message.append("          ").append(invalid.toString());
          message.append(StreamUtil.getLineSeparator());
        }
        if (rootPrecondition.getOnFail().equals(Preconditions.FailOption.HALT)) {
          e.printStackTrace();
          throw new MigrationFailedException(this,message.toString());
        }
 else         if (rootPrecondition.getOnFail().equals(Preconditions.FailOption.CONTINUE)) {
          skipChange=true;
          markRan=false;
          log.log(Level.INFO,"Continuing past ChangeSet: " + toString() + " due to precondition failure: "+ message);
        }
 else         if (rootPrecondition.getOnFail().equals(Preconditions.FailOption.MARK_RAN)) {
          skipChange=true;
          log.log(Level.INFO,"Marking ChangeSet: " + toString() + " ran due to precondition failure: "+ message);
        }
 else         if (rootPrecondition.getOnFail().equals(Preconditions.FailOption.WARN)) {
          log.log(Level.WARNING,"Running change set despite failed precondition.  ChangeSet: " + toString() + ": "+ message);
        }
 else {
          throw new MigrationFailedException(this,"Unexpected precondition onFail attribute: " + rootPrecondition.getOnFail());
        }
      }
catch (      PreconditionErrorException e) {
        StringBuffer message=new StringBuffer();
        message.append(StreamUtil.getLineSeparator());
        for (        ErrorPrecondition invalid : e.getErrorPreconditions()) {
          message.append("          ").append(invalid.toString());
          message.append(StreamUtil.getLineSeparator());
        }
        if (rootPrecondition.getOnError().equals(Preconditions.ErrorOption.HALT)) {
          throw new MigrationFailedException(this,message.toString());
        }
 else         if (rootPrecondition.getOnError().equals(Preconditions.ErrorOption.CONTINUE)) {
          skipChange=true;
          markRan=false;
          log.log(Level.INFO,"Continuing past ChangeSet: " + toString() + " due to precondition error: "+ message);
        }
 else         if (rootPrecondition.getOnError().equals(Preconditions.ErrorOption.MARK_RAN)) {
          skipChange=true;
          markRan=true;
          log.log(Level.INFO,"Marking ChangeSet: " + toString() + " due ran to precondition error: "+ message);
        }
 else         if (rootPrecondition.getOnError().equals(Preconditions.ErrorOption.WARN)) {
          log.log(Level.WARNING,"Running change set despite errored precondition.  ChangeSet: " + toString() + ": "+ message);
        }
 else {
          throw new MigrationFailedException(this,"Unexpected precondition onError attribute: " + rootPrecondition.getOnError());
        }
        database.rollback();
      }
    }
    if (!skipChange) {
      for (      Change change : changes) {
        try {
          change.setUp();
        }
 catch (        SetupException se) {
          throw new MigrationFailedException(this,se);
        }
      }
      log.finest("Reading ChangeSet: " + toString());
      for (      Change change : getChanges()) {
        database.executeStatements(change,sqlVisitors);
        log.finest(change.getConfirmationMessage());
      }
      if (runInTransaction) {
        database.commit();
      }
      log.finest("ChangeSet " + toString() + " has been successfully run.");
    }
 else {
      log.finest("Skipping ChangeSet: " + toString());
    }
  }
 catch (  Exception e) {
    try {
      database.rollback();
    }
 catch (    Exception e1) {
      throw new MigrationFailedException(this,e);
    }
    if (getFailOnError() != null && !getFailOnError()) {
      log.log(Level.INFO,"Change set " + toString(false) + " failed, but failOnError was false",e);
    }
 else {
      if (e instanceof MigrationFailedException) {
        throw ((MigrationFailedException)e);
      }
 else {
        throw new MigrationFailedException(this,e);
      }
    }
  }
 finally {
    if (!runInTransaction && !database.getAutoCommitMode()) {
      try {
        database.setAutoCommit(false);
      }
 catch (      JDBCException e) {
        throw new MigrationFailedException(this,"Could not reset autocommit");
      }
    }
  }
  return markRan;
}
