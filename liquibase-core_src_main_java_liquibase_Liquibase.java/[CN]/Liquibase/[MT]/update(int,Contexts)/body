{
  changeLogParameters.setContexts(contexts);
  LockService lockService=LockServiceFactory.getInstance().getLockService(database);
  lockService.waitForLock();
  try {
    DatabaseChangeLog changeLog=ChangeLogParserFactory.getInstance().getParser(changeLogFile,resourceAccessor).parse(changeLogFile,changeLogParameters,resourceAccessor);
    checkLiquibaseTables(true,changeLog,contexts);
    changeLog.validate(database,contexts);
    ChangeLogIterator logIterator=new ChangeLogIterator(changeLog,new ShouldRunChangeSetFilter(database,ignoreClasspathPrefix),new ContextChangeSetFilter(contexts),new DbmsChangeSetFilter(database),new CountChangeSetFilter(changesToApply));
    logIterator.run(createUpdateVisitor(),database);
  }
  finally {
    lockService.releaseLock();
  }
}
