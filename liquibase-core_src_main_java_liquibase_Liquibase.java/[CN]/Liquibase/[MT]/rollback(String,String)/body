{
  changeLogParameters.setContexts(StringUtils.splitAndTrim(contexts,","));
  LockService lockService=LockService.getInstance(database);
  lockService.waitForLock();
  try {
    DatabaseChangeLog changeLog=ChangeLogParserFactory.getInstance().getParser(changeLogFile).parse(changeLogFile,changeLogParameters,resourceAccessor);
    checkDatabaseChangeLogTable(false,changeLog);
    changeLog.validate(database);
    List<RanChangeSet> ranChangeSetList=database.getRanChangeSetList();
    ChangeLogIterator logIterator=new ChangeLogIterator(changeLog,new AfterTagChangeSetFilter(tagToRollBackTo,ranChangeSetList),new ActuallyExecutedChangeSetFilter(ranChangeSetList),new ContextChangeSetFilter(contexts),new DbmsChangeSetFilter(database));
    logIterator.run(new RollbackVisitor(database),database);
  }
  finally {
    lockService.releaseLock();
  }
}
