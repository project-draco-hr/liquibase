{
  SnapshotControl snapshotControl=new SnapshotControl(database);
  snapshotControl.setSnapshotListener(snapshotListener);
  CatalogAndSchema[] schemas=this.schemas;
  if (schemas == null) {
    schemas=new CatalogAndSchema[]{database.getDefaultSchema()};
  }
  DatabaseSnapshot snapshot=SnapshotGeneratorFactory.getInstance().createSnapshot(schemas,database,snapshotControl);
  String format=getSerializerFormat();
  if (format == null) {
    format="txt";
  }
  return SnapshotSerializerFactory.getInstance().getSerializer(format).serialize(snapshot,true);
}
