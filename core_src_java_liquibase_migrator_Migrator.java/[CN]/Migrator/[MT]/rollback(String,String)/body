{
  LockHandler lockHandler=LockHandler.getInstance(database);
  lockHandler.waitForLock();
  try {
    database.checkDatabaseChangeLogTable();
    DatabaseChangeLog changeLog=new ChangeLogParser().parse(changeLogFile,fileOpener);
    changeLog.validate(database);
    ChangeLogIterator logIterator=new ChangeLogIterator(changeLog,new AfterTagChangeSetFilter(tagToRollBackTo,database.getRanChangeSetList()),new ContextChangeSetFilter(contexts),new DbmsChangeSetFilter(database));
    logIterator.run(new RollbackVisitor(database));
  }
  finally {
    lockHandler.releaseLock();
  }
}
