{
  if (!migrator.getDatabase().doesChangeLogLockTableExist()) {
    if (migrator.getMode().equals(Migrator.EXECUTE_MODE) || migrator.getMode().equals(Migrator.EXECUTE_ROLLBACK_MODE)) {
      throw new MigrationFailedException("Could not aquire lock, table does not exist");
    }
 else {
      return true;
    }
  }
  Connection conn=getConnection();
  Statement stmt=null;
  PreparedStatement pstmt=null;
  ResultSet rs=null;
  try {
    stmt=conn.createStatement();
    rs=stmt.executeQuery(getSelectChangeLogLockSQL());
    if (!rs.next()) {
      throw new MigrationFailedException("Error checking database lock status");
    }
    boolean locked=rs.getBoolean(1);
    if (locked) {
      return false;
    }
 else {
      pstmt=conn.prepareStatement("update databasechangeloglock set locked=?, lockgranted=?, lockedby=? where id=1".toUpperCase());
      pstmt.setBoolean(1,true);
      pstmt.setTimestamp(2,new Timestamp(new java.util.Date().getTime()));
      pstmt.setString(3,InetAddress.getLocalHost().getCanonicalHostName() + " (" + InetAddress.getLocalHost().getHostAddress()+ ")");
      if (pstmt.executeUpdate() != 1) {
        throw new MigrationFailedException("Did not update change log lock correctly");
      }
      conn.commit();
      log.info("Successfully aquired change log lock");
      return true;
    }
  }
 catch (  Exception e) {
    throw new MigrationFailedException(e);
  }
 finally {
    if (rs != null) {
      try {
        rs.close();
      }
 catch (      SQLException e) {
        ;
      }
    }
    if (stmt != null) {
      try {
        stmt.close();
      }
 catch (      SQLException e) {
        ;
      }
    }
    if (pstmt != null) {
      try {
        pstmt.close();
      }
 catch (      SQLException e) {
        ;
      }
    }
  }
}
