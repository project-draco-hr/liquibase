{
  if (database instanceof DerbyDatabase) {
    throw new UnsupportedChangeException("Add Lookup Table currently not supported in Derby");
  }
 else   if (database instanceof HsqlDatabase) {
    throw new UnsupportedChangeException("Add Lookup Table currently not supported in HSQLDB");
  }
 else   if (database instanceof CacheDatabase) {
    throw new UnsupportedChangeException("Add Lookup Table not currently supported for Cache");
  }
 else   if (database instanceof FirebirdDatabase) {
    throw new UnsupportedChangeException("Add Lookup Table not currently supported for Firebird");
  }
  List<SqlStatement> statements=new ArrayList<SqlStatement>();
  SqlStatement[] createTablesSQL={new RawSqlStatement("CREATE TABLE " + database.escapeTableName(getNewTableSchemaName(),getNewTableName()) + " AS SELECT DISTINCT "+ getExistingColumnName()+ " AS "+ getNewColumnName()+ " FROM "+ database.escapeTableName(getExistingTableSchemaName(),getExistingTableName())+ " WHERE "+ getExistingColumnName()+ " IS NOT NULL")};
  if (database instanceof MSSQLDatabase) {
    createTablesSQL=new SqlStatement[]{new RawSqlStatement("SELECT DISTINCT " + getExistingColumnName() + " AS "+ getNewColumnName()+ " INTO "+ database.escapeTableName(getNewTableSchemaName(),getNewTableName())+ " FROM "+ database.escapeTableName(getExistingTableSchemaName(),getExistingTableName())+ " WHERE "+ getExistingColumnName()+ " IS NOT NULL")};
  }
 else   if (database instanceof DB2Database) {
    createTablesSQL=new SqlStatement[]{new RawSqlStatement("CREATE TABLE " + database.escapeTableName(getNewTableSchemaName(),getNewTableName()) + " AS (SELECT "+ getExistingColumnName()+ " AS "+ getNewColumnName()+ " FROM "+ database.escapeTableName(getExistingTableSchemaName(),getExistingTableName())+ ") WITH NO DATA"),new RawSqlStatement("INSERT INTO " + database.escapeTableName(getNewTableSchemaName(),getNewTableName()) + " SELECT DISTINCT "+ getExistingColumnName()+ " FROM "+ database.escapeTableName(getExistingTableSchemaName(),getExistingTableName())+ " WHERE "+ getExistingColumnName()+ " IS NOT NULL")};
  }
  statements.addAll(Arrays.asList(createTablesSQL));
  if (!(database instanceof OracleDatabase)) {
    AddNotNullConstraintChange addNotNullChange=new AddNotNullConstraintChange();
    addNotNullChange.setSchemaName(getNewTableSchemaName());
    addNotNullChange.setTableName(getNewTableName());
    addNotNullChange.setColumnName(getNewColumnName());
    addNotNullChange.setColumnDataType(getNewColumnDataType());
    statements.addAll(Arrays.asList(addNotNullChange.generateStatements(database)));
  }
  if (database instanceof DB2Database) {
    statements.add(new ReorganizeTableStatement(getNewTableSchemaName(),getNewTableName()));
  }
  AddPrimaryKeyChange addPKChange=new AddPrimaryKeyChange();
  addPKChange.setSchemaName(getNewTableSchemaName());
  addPKChange.setTableName(getNewTableName());
  addPKChange.setColumnNames(getNewColumnName());
  statements.addAll(Arrays.asList(addPKChange.generateStatements(database)));
  if (database instanceof DB2Database) {
    statements.add(new ReorganizeTableStatement(getNewTableSchemaName(),getNewTableName()));
  }
  AddForeignKeyConstraintChange addFKChange=new AddForeignKeyConstraintChange();
  addFKChange.setBaseTableSchemaName(getExistingTableSchemaName());
  addFKChange.setBaseTableName(getExistingTableName());
  addFKChange.setBaseColumnNames(getExistingColumnName());
  addFKChange.setReferencedTableSchemaName(getNewTableSchemaName());
  addFKChange.setReferencedTableName(getNewTableName());
  addFKChange.setReferencedColumnNames(getNewColumnName());
  addFKChange.setConstraintName(getFinalConstraintName());
  statements.addAll(Arrays.asList(addFKChange.generateStatements(database)));
  return statements.toArray(new SqlStatement[statements.size()]);
}
