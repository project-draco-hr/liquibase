{
  if (database instanceof DerbyDatabase) {
    throw new UnsupportedChangeException("Add Lookup Table currently not supported in Derby");
  }
 else   if (database instanceof HsqlDatabase) {
    throw new UnsupportedChangeException("Add Lookup Table currently not supported in HSQLDB");
  }
 else   if (database instanceof CacheDatabase) {
    throw new UnsupportedChangeException("Add Lookup Table not currently supported for Cache");
  }
 else   if (database instanceof FirebirdDatabase) {
    throw new UnsupportedChangeException("Add Lookup Table not currently supported for Firebird");
  }
  List<SqlStatement> statements=new ArrayList<SqlStatement>();
  SqlStatement[] createTablesSQL={new RawSqlStatement("CREATE TABLE " + SqlUtil.escapeTableName(getNewTableName(),database) + " AS SELECT DISTINCT "+ getExistingColumnName()+ " AS "+ getNewColumnName()+ " FROM "+ SqlUtil.escapeTableName(getExistingTableName(),database)+ " WHERE "+ getExistingColumnName()+ " IS NOT NULL")};
  if (database instanceof MSSQLDatabase) {
    createTablesSQL=new SqlStatement[]{new RawSqlStatement("SELECT DISTINCT " + getExistingColumnName() + " AS "+ getNewColumnName()+ " INTO "+ SqlUtil.escapeTableName(getNewTableName(),database)+ " FROM "+ SqlUtil.escapeTableName(getExistingTableName(),database)+ " WHERE "+ getExistingColumnName()+ " IS NOT NULL")};
  }
 else   if (database instanceof DB2Database) {
    createTablesSQL=new SqlStatement[]{new RawSqlStatement("CREATE TABLE " + SqlUtil.escapeTableName(getNewTableName(),database) + " AS (SELECT "+ getExistingColumnName()+ " AS "+ getNewColumnName()+ " FROM "+ SqlUtil.escapeTableName(getExistingTableName(),database)+ ") WITH NO DATA"),new RawSqlStatement("INSERT INTO " + SqlUtil.escapeTableName(getNewTableName(),database) + " SELECT DISTINCT "+ getExistingColumnName()+ " FROM "+ SqlUtil.escapeTableName(getExistingTableName(),database)+ " WHERE "+ getExistingColumnName()+ " IS NOT NULL")};
  }
  statements.addAll(Arrays.asList(createTablesSQL));
  if (!(database instanceof OracleDatabase)) {
    AddNotNullConstraintChange addNotNullChange=new AddNotNullConstraintChange();
    addNotNullChange.setTableName(getNewTableName());
    addNotNullChange.setColumnName(getNewColumnName());
    addNotNullChange.setColumnDataType(getNewColumnDataType());
    statements.addAll(Arrays.asList(addNotNullChange.generateStatements(database)));
  }
  if (database instanceof DB2Database) {
    statements.add(new RawSqlStatement("CALL SYSPROC.ADMIN_CMD ('REORG TABLE " + getNewTableName() + "')"));
  }
  AddPrimaryKeyChange addPKChange=new AddPrimaryKeyChange();
  addPKChange.setTableName(getNewTableName());
  addPKChange.setColumnNames(getNewColumnName());
  statements.addAll(Arrays.asList(addPKChange.generateStatements(database)));
  if (database instanceof DB2Database) {
    statements.add(new RawSqlStatement("CALL SYSPROC.ADMIN_CMD ('REORG TABLE " + getNewTableName() + "')"));
  }
  AddForeignKeyConstraintChange addFKChange=new AddForeignKeyConstraintChange();
  addFKChange.setBaseTableName(getExistingTableName());
  addFKChange.setBaseColumnNames(getExistingColumnName());
  addFKChange.setReferencedTableName(getNewTableName());
  addFKChange.setReferencedColumnNames(getNewColumnName());
  addFKChange.setConstraintName(getFinalConstraintName());
  statements.addAll(Arrays.asList(addFKChange.generateStatements(database)));
  return statements.toArray(new SqlStatement[statements.size()]);
}
