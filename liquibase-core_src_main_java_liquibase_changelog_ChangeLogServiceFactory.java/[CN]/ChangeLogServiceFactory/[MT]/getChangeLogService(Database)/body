{
  if (services.containsKey(database)) {
    return services.get(database);
  }
  SortedSet<ChangeLogService> foundServices=new TreeSet<ChangeLogService>(new Comparator<ChangeLogService>(){
    @Override public int compare(    ChangeLogService o1,    ChangeLogService o2){
      return -1 * new Integer(o1.getPriority()).compareTo(o2.getPriority());
    }
  }
);
  for (  ChangeLogService service : registry) {
    if (service.supports(database)) {
      foundServices.add(service);
    }
  }
  if (foundServices.size() == 0) {
    throw new UnexpectedLiquibaseException("Cannot find ChangeLogService for " + database.getShortName());
  }
  try {
    ChangeLogService service=foundServices.iterator().next().getClass().newInstance();
    service.setDatabase(database);
    services.put(database,service);
    return service;
  }
 catch (  Exception e) {
    throw new UnexpectedLiquibaseException(e);
  }
}
