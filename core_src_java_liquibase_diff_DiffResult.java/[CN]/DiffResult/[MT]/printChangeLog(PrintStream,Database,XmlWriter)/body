{
  DocumentBuilderFactory factory=DocumentBuilderFactory.newInstance();
  DocumentBuilder documentBuilder=factory.newDocumentBuilder();
  documentBuilder.setEntityResolver(new LiquibaseSchemaResolver());
  Document doc=documentBuilder.newDocument();
  Element changeLogElement=doc.createElement("databaseChangeLog");
  changeLogElement.setAttribute("xmlns","http://www.liquibase.org/xml/ns/dbchangelog/" + XMLChangeLogParser.getSchemaVersion());
  changeLogElement.setAttribute("xmlns:xsi","http://www.w3.org/2001/XMLSchema-instance");
  changeLogElement.setAttribute("xsi:schemaLocation","http://www.liquibase.org/xml/ns/dbchangelog/" + XMLChangeLogParser.getSchemaVersion() + " http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-"+ XMLChangeLogParser.getSchemaVersion()+ ".xsd");
  doc.appendChild(changeLogElement);
  List<Change> changes=new ArrayList<Change>();
  addUnexpectedViewChanges(changes);
  addMissingTableChanges(changes,targetDatabase);
  addMissingColumnChanges(changes,targetDatabase);
  addChangedColumnChanges(changes);
  addMissingPrimaryKeyChanges(changes);
  addUnexpectedPrimaryKeyChanges(changes);
  addMissingUniqueConstraintChanges(changes);
  addUnexpectedUniqueConstraintChanges(changes);
  addMissingIndexChanges(changes);
  addUnexpectedIndexChanges(changes);
  if (diffData) {
    addInsertDataChanges(changes,dataDir);
  }
  addMissingForeignKeyChanges(changes);
  addUnexpectedForeignKeyChanges(changes);
  addUnexpectedColumnChanges(changes);
  addMissingSequenceChanges(changes);
  addUnexpectedSequenceChanges(changes);
  addMissingViewChanges(changes);
  addUnexpectedTableChanges(changes);
  ChangeLogSerializer changeLogSerializer=new ChangeLogSerializer(doc);
  for (  Change change : changes) {
    Element changeSet=doc.createElement("changeSet");
    changeSet.setAttribute("author",getChangeSetAuthor());
    changeSet.setAttribute("id",generateId());
    if (getChangeSetContext() != null) {
      changeSet.setAttribute("context",getChangeSetContext());
    }
    changeSet.appendChild(changeLogSerializer.createNode(change));
    doc.getDocumentElement().appendChild(changeSet);
  }
  xmlWriter.write(doc,out);
  out.flush();
}
